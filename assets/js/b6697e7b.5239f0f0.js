"use strict";(self.webpackChunksandwich_site=self.webpackChunksandwich_site||[]).push([[2011],{5152:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>l});var s=i(6070),o=i(6113);const r={id:"sandwich-webdriver",title:"Selenium"},t=void 0,a={id:"extensions/sandwich-webdriver",title:"Selenium",description:"Setting up Selenium tests normally requires manual work to obtain the Selenium server JAR file and a driver program for your browser, launch the server, and connect to the server with your client library. It can be error-prone to make sure the versions are compatible and everything runs smoothly.",source:"@site/docs/extensions/sandwich-webdriver.md",sourceDirName:"extensions",slug:"/extensions/sandwich-webdriver",permalink:"/sandwich/docs/extensions/sandwich-webdriver",draft:!1,unlisted:!1,editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/extensions/sandwich-webdriver.md",tags:[],version:"current",frontMatter:{id:"sandwich-webdriver",title:"Selenium"},sidebar:"docs",previous:{title:"QuickCheck",permalink:"/sandwich/docs/extensions/sandwich-quickcheck"},next:{title:"Base contexts",permalink:"/sandwich/docs/context-libraries/sandwich-contexts"}},d={},l=[{value:"Browser sessions",id:"browser-sessions",level:2},{value:"Window positioning",id:"window-positioning",level:2},{value:"Launching browsers in the background",id:"launching-browsers-in-the-background",level:2},{value:"Headless",id:"headless",level:3},{value:"Xvfb",id:"xvfb",level:3},{value:"Recording videos",id:"recording-videos",level:2},{value:"Manually",id:"manually",level:3},{value:"With command line options",id:"with-command-line-options",level:3},{value:"Screenshots",id:"screenshots",level:2},{value:"Custom Selenium and driver binaries",id:"custom-selenium-and-driver-binaries",level:2},{value:"Running tests in parallel with a webdriver pool",id:"running-tests-in-parallel-with-a-webdriver-pool",level:2}];function c(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Setting up Selenium tests normally requires manual work to obtain the Selenium server JAR file and a driver program for your browser, launch the server, and connect to the server with your client library. It can be error-prone to make sure the versions are compatible and everything runs smoothly."}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"sandwich-webdriver"})," extension streamlines this by automatically downloading the latest compatible binary files and introducing the contexts you need to use the ",(0,s.jsx)(n.a,{href:"https://hackage.haskell.org/package/webdriver",children:"webdriver"})," package within Sandwich. Here's how easy it is to get started:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'import Test.Sandwich\nimport Test.Sandwich.WebDriver\nimport Test.WebDriver\n\nspec :: TopSpec\nspec = introduceWebDriver defaultWdOptions $ do\n  it "opens Google and searches" $ withSession1 $ do\n    openPage "http://www.google.com"\n    search <- findElem (ByCSS "*[title=\'Search\']")\n    click search\n    sendKeys "asdf\\n" search\n\nmain :: IO ()\nmain = runSandwich defaultOptions spec\n'})}),"\n",(0,s.jsxs)(n.p,{children:["To see a demo, try running ",(0,s.jsx)(n.code,{children:"stack run demo-webdriver"})," in the Sandwich repo."]}),"\n",(0,s.jsx)(n.h2,{id:"browser-sessions",children:"Browser sessions"}),"\n",(0,s.jsxs)(n.p,{children:["You can start a Selenium session using the ",(0,s.jsx)(n.code,{children:"withSession"})," function. It accepts a string key representing the name of the session. Each time a new session name is seen, it will be created if it doesn't already exist."]}),"\n",(0,s.jsxs)(n.p,{children:["The library provides ",(0,s.jsx)(n.code,{children:"withSession1"}),"/",(0,s.jsx)(n.code,{children:"withSession2"})," as convenience functions for ",(0,s.jsx)(n.code,{children:'withSession "browser1"'}),"/",(0,s.jsx)(n.code,{children:'withSession "browser2"'}),", but you can use your own keys if you need."]}),"\n",(0,s.jsx)(n.p,{children:"For example, the code below opens two windows with a different site in each."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'spec :: TopSpec\nspec = introduceWebDriver defaultWdOptions $ do\n  describe "two browser sessions" $ do\n    it "opens Google" $ withSession1 $ openPage "http://www.google.com"\n    it "opens Yahoo" $ withSession2 $ openPage "http://www.yahoo.com"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"window-positioning",children:"Window positioning"}),"\n",(0,s.jsxs)(n.p,{children:["You can use the functions in ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich-webdriver/docs/Test-Sandwich-WebDriver-Windows.html",children:"Test.Sandwich.WebDriver.Windows"})," to arrange browser windows on the screen. This is useful when you want to watch two browsers simultaneously accessing a collaborative app."]}),"\n",(0,s.jsxs)(n.p,{children:["The code below extends the previous example with window positioning. You can find this in the ",(0,s.jsx)(n.code,{children:"webdriver-positioning"})," demo."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'positioning :: TopSpec\npositioning = introduceWebDriver defaultWdOptions $ do\n  describe "two windows side by side" $ do\n    it "opens Google" $ withSession1 $ do\n      openPage "http://www.google.com"\n      setWindowLeftSide\n\n    it "opens Yahoo" $ withSession2 $ do\n      openPage "http://www.yahoo.com"\n      setWindowRightSide\n'})}),"\n",(0,s.jsx)(n.h2,{id:"launching-browsers-in-the-background",children:"Launching browsers in the background"}),"\n",(0,s.jsxs)(n.p,{children:["This package makes it easy to run Selenium tests in the background, using either ",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Xvfb",children:"Xvfb"})," or the headless mode of your browser."]}),"\n",(0,s.jsx)(n.h3,{id:"headless",children:"Headless"}),"\n",(0,s.jsxs)(n.p,{children:["Many browsers now have the ability to natively run in headless mode. For example, passing these modified ",(0,s.jsx)(n.code,{children:"WdOptions"})," to ",(0,s.jsx)(n.code,{children:"introduceWebDriver"})," will run using headless Firefox."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:"wdOptions = defaultWdOptions {\n  capabilities = firefoxCapabilities Nothing\n  , runMode = RunHeadless defaultHeadlessConfig\n  }\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, if you use Sandwich's ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich/docs/Test-Sandwich.html#v:runSandwichWithCommandLineArgs",children:"runSandwichWithCommandLineArgs"})," in conjunction with ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich-webdriver/docs/Test-Sandwich-WebDriver.html#v:introduceWebDriverOptions",children:"introduceWebDriverOptions"}),", you can enable headless mode by passing ",(0,s.jsx)(n.code,{children:"--headless"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"xvfb",children:"Xvfb"}),"\n",(0,s.jsxs)(n.p,{children:['Xvfb can be used to run your browser on a separate, "virtual" X11 display, different from the one connected to your monitor. This was more useful before headless browser modes existed, but it\'s still important because it gives you the ability to record ',(0,s.jsx)(n.strong,{children:"video"}),". When a Selenium test is running on an Xvfb display, you can use ",(0,s.jsx)(n.a,{href:"https://ffmpeg.org/",children:"ffmpeg"})," to record videos of the test runs for later examination."]}),"\n",(0,s.jsx)(n.p,{children:"Xvfb mode can be configured manually just like headless mode."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:"wdOptions = defaultWdOptions {\n  capabilities = chromeCapabilities\n  , runMode = RunInXvfb XvfbConfig\n  }\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Or, if you use Sandwich's ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich/docs/Test-Sandwich.html#v:runSandwichWithCommandLineArgs",children:"runSandwichWithCommandLineArgs"})," in conjunction with ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich-webdriver/docs/Test-Sandwich-WebDriver.html#v:introduceWebDriverOptions",children:"introduceWebDriverOptions"}),", you can enable Xvfb mode by passing ",(0,s.jsx)(n.code,{children:"--xvfb"}),"."]}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"Xvfb and ffmpeg must be installed in the test environment to use these features."})}),"\n",(0,s.jsx)(n.h2,{id:"recording-videos",children:"Recording videos"}),"\n",(0,s.jsxs)(n.p,{children:["As discussed above, recording video doesn't work in headless (",(0,s.jsx)(n.code,{children:"--headless"}),") mode. It requires normal (",(0,s.jsx)(n.code,{children:"--current"}),") or Xvfb (",(0,s.jsx)(n.code,{children:"--xvfb"}),") mode."]}),"\n",(0,s.jsx)(n.h3,{id:"manually",children:"Manually"}),"\n",(0,s.jsxs)(n.p,{children:["Using the methods in ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich-webdriver/docs/Test-Sandwich-WebDriver-Video.html",children:"Test.Sandwich.WebDriver.Video"}),", you can wrap arbitrary sections of a test in video recording. The example below can be found in the ",(0,s.jsx)(n.code,{children:"webdriver-video"})," demo."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'manualVideo :: TopSpec\nmanualVideo = introduceWebDriver defaultWdOptions $ do\n  describe "video recording" $ do\n    it "opens Google" $ withSession1 $ do\n      openPage "http://www.google.com"\n\n      Just dir <- getCurrentFolder\n      let path = dir </> "video" -- No extension needed\n      bracket (startBrowserVideoRecording path defaultVideoSettings) endVideoRecording $ \\_ -> do\n        search <- findElem (ByCSS [i|*[title="Search"]|])\n        click search\n        sendKeys "Haskell Sandwich" search\n        findElem (ByCSS [i|input[type="submit"]|]) >>= click\n'})}),"\n",(0,s.jsxs)(n.p,{children:["You can also wrap video around multiple tests by using the ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich/docs/Test-Sandwich.html#v:around",children:"around"})," node, or around individual tests using ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich/docs/Test-Sandwich.html#v:aroundEach",children:"aroundEach"}),", etc."]}),"\n",(0,s.jsx)(n.h3,{id:"with-command-line-options",children:"With command line options"}),"\n",(0,s.jsxs)(n.p,{children:["If you use Sandwich's ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich/docs/Test-Sandwich.html#v:runSandwichWithCommandLineArgs",children:"runSandwichWithCommandLineArgs"})," in conjunction with ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich-webdriver/docs/Test-Sandwich-WebDriver.html#v:introduceWebDriverOptions",children:"introduceWebDriverOptions"}),", then you can take advantage of the built-in command line arguments ",(0,s.jsx)(n.code,{children:"--individual-videos"})," and ",(0,s.jsx)(n.code,{children:"--error-videos"}),". The former will record videos of every individual test and store them in the corresponding folder on disk. The latter will do the same, but will delete the videos if the test ran successfully, so you only end up with error videos."]}),"\n",(0,s.jsx)(n.p,{children:"You can try this out by running:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"stack run demo-webdriver -- --individual-videos\n"})}),"\n",(0,s.jsx)(n.h2,{id:"screenshots",children:"Screenshots"}),"\n",(0,s.jsx)(n.p,{children:"Because every Sandwich test tree has an associated directory in the filesystem, it's easy to capture screenshots during a test."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'Just dir <- getCurrentFolder\nscreenshot >>= liftIO . BL.writeFile (dir </> "screenshot.png")\n'})}),"\n",(0,s.jsx)(n.h2,{id:"custom-selenium-and-driver-binaries",children:"Custom Selenium and driver binaries"}),"\n",(0,s.jsx)(n.p,{children:"By default, the WebDriver machinery will obtain the Selenium JAR and driver binaries from the web automatically. However, you can also manually configure which ones are used by passing a disk path."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'data WdOptions = WdOptions {\n  ...\n  , seleniumToUse = UseSeleniumAt "/path/to/selenium.jar"\n  , chromeDriverToUse = UseChromeDriverAt "/path/to/chromedriver"\n  , geckoDriverToUse = UseGeckoDriverAt "/path/to/geckodriver"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Alternatively, you can pass ",(0,s.jsx)(n.a,{href:"http://hackage.haskell.org/package/sandwich-webdriver/docs/Test-Sandwich-WebDriver-Config.html#t:SeleniumToUse",children:"DownloadSeleniumFrom"})," with a URL to download, and similarly for the other options. Please see the Haddocks for more details."]}),"\n",(0,s.jsx)(n.h2,{id:"running-tests-in-parallel-with-a-webdriver-pool",children:"Running tests in parallel with a webdriver pool"}),"\n",(0,s.jsxs)(n.p,{children:["If you have a lot of test files, you probably want to run them in parallel so the test suite finishes faster. However, you probably don't want to run them ",(0,s.jsx)(n.strong,{children:"all"})," in parallel, since running that many browser sessions could bog down your CI machine. A good solution is to use ",(0,s.jsx)(n.a,{href:"https://hackage.haskell.org/package/resource-pool",children:"Data.Pool"})," to introduce a fixed-size pool of reusable WebDriver contexts."]}),"\n",(0,s.jsxs)(n.p,{children:["You can follow along with this example in the ",(0,s.jsx)(n.code,{children:"webdriver-pool"})," demo."]}),"\n",(0,s.jsx)(n.p,{children:"The first thing we need to do is come up with a label and introduce a pool of the desired size."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'webDriverPool = Label :: Label "webDriverPool" (Pool WebDriver)\ntype HasWebDriverPool context = HasLabel context "webDriverPool" (Pool WebDriver)\n\nintroduceWebDriverPool poolSize wdOptions\' =\n  introduce "Introduce webdriver pool" webDriverPool alloc cleanup\n  where\n    alloc = do\n      wdOptions <- addCommandLineOptionsToWdOptions\n                   <$> (getCommandLineOptions @())\n                   <*> pure wdOptions\'\n      wdOptions <- addCommandLineOptionsToWdOptions clo wdOptions\'\n      runRoot <- fromMaybe "/tmp" <$> getRunRoot\n      liftIO $ createPool\n        (allocateWebDriver\' runRoot wdOptions) cleanupWebDriver\' 1 30 poolSize\n    cleanup = liftIO . destroyAllResources\n'})}),"\n",(0,s.jsxs)(n.p,{children:["There's some plumbing here because we want to pipe the command line options through. The important part is at the end, where we make a pool that knows how to allocate and deallocate WebDrivers using the lower-level ",(0,s.jsx)(n.code,{children:"allocateWebDriver'"})," and ",(0,s.jsx)(n.code,{children:"cleanupWebDriver'"})," functions."]}),"\n",(0,s.jsxs)(n.p,{children:["Next, we make another introduce node to ",(0,s.jsx)(n.em,{children:"claim"})," a WebDriver from the pool."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'claimWebdriver spec = introduceWith\' (\n  defaultNodeOptions {nodeOptionsRecordTime=False, nodeOptionsCreateFolder=False}\n  ) "Claim webdriver" webdriver wrappedAction spec\n  where\n    wrappedAction action = do\n      pool <- getContext webDriverPool\n      withResource pool $ \\sess ->\n        (void $ action sess) `finally` closeAllSessions sess\n'})}),"\n",(0,s.jsxs)(n.p,{children:["There's also some plumbing here where we tweak the node options of this to play better with ",(0,s.jsx)(n.a,{href:"../timing",children:"test timing"}),". This code obtains the pool context, then claims a WebDriver to pass to its sub-nodes. It also cleans up at the end by calling ",(0,s.jsx)(n.code,{children:"closeAllSessions"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Having written these functions, we can finally write our tests. The following will run all the tests, up to four at a time, re-using the WebDrivers among them."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-haskell",children:'tests :: TopSpecWithOptions\ntests =\n  introduceWebDriverPool 4 defaultWdOptions $\n    parallel $\n      replicateM_ 20 $\n        claimWebdriver $\n          it "opens Google" $ withSession1 $\n            openPage "http://www.google.com"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Of course, in real use you probably want to introduce different tests to run in parallel. You can use ",(0,s.jsx)(n.a,{href:"../discovery",children:"Test Discovery"})," to automatically generate them."]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},6113:(e,n,i)=>{i.d(n,{R:()=>t,x:()=>a});var s=i(758);const o={},r=s.createContext(o);function t(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);